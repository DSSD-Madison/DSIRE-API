name: AWS Deploy
run-name: Build and deploy on AWS

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - preview/**

# Required for aws-actions/configure-aws-credentials
permissions:
  id-token: write
  contents: read


jobs:

  get-name:
      name: Get deployment names
      runs-on: ubuntu-latest
      environment: AWS_Development
      outputs:
        NAME: ${{ steps.get-name.outputs.NAME }}
        PACKAGE_NAME: api_${{ steps.get-name.outputs.NAME }}
        EXT_DEPS_PACKAGE_NAME: api-ext-deps_${{ steps.get-name.outputs.NAME }}
        HANDLER_NAME: DsireApi_${{ steps.get-name.outputs.NAME }}
        HANDLER_STACK_NAME: DsireApi-${{ steps.get-name.outputs.NAME }}

      steps:

        - name: Generate deployment names for branch ${{ github.ref_name }} (${{ github.event.ref }})
          id: get-name
          env:
            SED_REF_NAME: s~refs/heads/~~g; s~\.~-~g; s~_~-~g; s~/~-~g
          run: |
            NAME=$(echo "${{ github.ref_name }}" | sed "${SED_REF_NAME}")
            echo "NAME=${NAME}" >> $GITHUB_OUTPUT


  build-package:
    name: Build/zip API for Lambda
    runs-on: ubuntu-latest
    environment: AWS_Development
    needs: get-name

    steps:
      - name: Checkout branch ${{ github.ref_name }}
        uses: actions/checkout@v3

      - name: Install Node.js version ${{ vars.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ vars.NODE_VERSION }}

      - name: Set NODE_ENV for production
        run: echo "NODE_ENV=production" >> $GITHUB_ENV
        if: github.ref_name == 'main'
      - name: Set NODE_ENV for development
        run: echo "NODE_ENV=development" >> $GITHUB_ENV
        if: github.ref_name != 'main'

      - name: Install dependencies
        working-directory: api
        run: npm ci

      - name: Generate Prisma client
        working-directory: api
        run: npx prisma generate

      - name: Bundle and minify TypeScript (production build)
        working-directory: api
        run: npm run build-main
        if: github.ref_name == 'main'

      - name: Bundle and sourcemap TypeScript (development build)
        working-directory: api
        run: npm run build
        if: github.ref_name != 'main'

      - name: Copy Prisma client (external dependencies) to distribution context in AWS hierarchy
        run: |
          mkdir -p dist/api/nodejs/node18/node_modules && cp -r api/node_modules/{@prisma,.prisma} dist/api/nodejs/node18/node_modules/

      - name: Remove extraneous native Prisma query engines
        working-directory: dist/api/nodejs/node18/node_modules/.prisma/client
        run: rm libquery_engine-debian*

      - name: Zip API package ${{ needs.get-name.outputs.PACKAGE_NAME }}
        working-directory: dist/api
        run: zip -9 ../${{ needs.get-name.outputs.PACKAGE_NAME }}.zip index.cjs
      - name: Zip external dependency package ${{ needs.get-name.outputs.EXT_DEPS_PACKAGE_NAME }}
        working-directory: dist/api
        run: zip -9 -r ../${{ needs.get-name.outputs.EXT_DEPS_PACKAGE_NAME }}.zip nodejs

      - name: Upload API package as artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ needs.get-name.outputs.PACKAGE_NAME }}
          path: dist/${{ needs.get-name.outputs.PACKAGE_NAME }}.zip
      - name: Upload external dependency package as artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ needs.get-name.outputs.EXT_DEPS_PACKAGE_NAME }}
          path: dist/${{ needs.get-name.outputs.EXT_DEPS_PACKAGE_NAME }}.zip

  sync-packages:
    name: Sync packages with S3
    runs-on: ubuntu-latest
    environment: AWS_Development
    needs:
      - get-name
      - build-package

    steps:

      - name: Download API package as artifact
        uses: actions/download-artifact@v3
        with:
          name: ${{ needs.get-name.outputs.PACKAGE_NAME }}
      - name: Download external dependency package as artifact
        uses: actions/download-artifact@v3
        with:
          name: ${{ needs.get-name.outputs.EXT_DEPS_PACKAGE_NAME }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: ${{ vars.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}

      - name: Sync packages with S3
        run: aws s3 sync --size-only . s3://${{ vars.PACKAGE_BUCKET }}

  deploy-handler:
    name: Configure Lambda handler
    runs-on: ubuntu-latest
    environment: AWS_Development
    needs:
      - get-name
    outputs:
      API_URL: ${{ steps.get-root.outputs.ROOT_API_URL }}/${{ needs.get-name.outputs.NAME }}

    steps:
      - name: Checkout branch ${{ github.ref_name }}
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: ${{ vars.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}

      - name: Deploy handler stack
        working-directory: aws/CloudFormation
        env:
          CF_TAGS: prouduct=DsireApi
        run: |
          aws cloudformation deploy --template-file DsireApiHandler.yaml \
              --parameter-overrides Name=${{ needs.get-name.outputs.NAME }} \
              --stack-name ${{ needs.get-name.outputs.HANDLER_STACK_NAME }} \
              --tags ${CF_TAGS} --no-fail-on-empty-changeset

      - name: Get API URL (for handler environments & templating)
        id: get-root
        run: |
          ROOT_API_URL=$(aws cloudformation list-exports --query "Exports[?Name=='ApiUrl'].Value" --no-paginate --output text)
          echo "ROOT_API_URL=${ROOT_API_URL}" >> $GITHUB_OUTPUT

  deploy-api:
      name: Deploy API on Lambda
      runs-on: ubuntu-latest
      environment: AWS_Development
      needs:
        - get-name
        - sync-packages
        - deploy-handler

      steps:

        - name: Configure AWS credentials
          uses: aws-actions/configure-aws-credentials@v1
          with:
            aws-region: ${{ vars.AWS_REGION }}
            role-to-assume: ${{ secrets.AWS_ROLE_ARN }}

        - name: Get old dependency layer ARN
          # The handler name is the same as the layer name (DsireApiHandler.yaml)
          # Have to query the old ARN this way as publish-layer-version doesn't want the versioned ARN
          # But we can get the new (versioned) ARN from that command because update-function-configuration does :)
          # So OLD_DEPENDENCIES_ARN is non-versioned layer ARN; DEPENDENCIES_ARN is versioned layer ARN
          run: |
            OLD_DEPENDENCIES_ARN=$(aws lambda list-layers --query "Layers[?LayerName=='${{ needs.get-name.outputs.HANDLER_NAME }}'].LayerArn" --no-paginate --output text)
            echo "OLD_DEPENDENCIES_ARN=${OLD_DEPENDENCIES_ARN}" >> $GITHUB_ENV

        - name: Create new dependency layer version from package
          run: |
            DEPENDENCIES_ARN=$(aws lambda publish-layer-version \
                --layer-name "${OLD_DEPENDENCIES_ARN}" \
                --content S3Bucket=${{ vars.PACKAGE_BUCKET }},S3Key=${{ needs.get-name.outputs.EXT_DEPS_PACKAGE_NAME }}.zip \
                --query LayerVersionArn --no-paginate --output text)
            echo "DEPENDENCIES_ARN=${DEPENDENCIES_ARN}" >> $GITHUB_ENV

        - name: Deploy API package on handler with new dependency layer
          run: |
            aws lambda update-function-code --function-name="${{ needs.get-name.outputs.HANDLER_NAME }}" --s3-bucket ${{ vars.PACKAGE_BUCKET }} --s3-key ${{ needs.get-name.outputs.PACKAGE_NAME }}.zip > /dev/null
            aws lambda wait function-updated --function-name="${{ needs.get-name.outputs.HANDLER_NAME }}"
            aws lambda update-function-configuration --function-name="${{ needs.get-name.outputs.HANDLER_NAME }}" --layers "${DEPENDENCIES_ARN}" > /dev/null
            aws lambda wait function-updated --function-name="${{ needs.get-name.outputs.HANDLER_NAME }}"

  sync-environment-lambda:
    name: Sync secrets with Lambda
    runs-on: ubuntu-latest
    environment: AWS_Development
    needs:
      - get-name
      - deploy-handler
      - deploy-api

    steps:

      - name: Set APPROVER_EMAIL for production
        run: echo "APPROVER_EMAIL=${{ secrets.APPROVER_EMAIL }}" >> $GITHUB_ENV
        if: github.ref_name == 'main'
      - name: Set APPROVER_EMAIL for development
        run: echo "APPROVER_EMAIL=${{ secrets.APPROVER_EMAIL_development }}" >> $GITHUB_ENV
        if: github.ref_name != 'main'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: ${{ vars.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}

      - name: Sync all environment secrets with Lambda handlers
        env:
          API_URL: ${{ needs.deploy-handler.outputs.API_URL }}
          APPROVER_EMAIL: ${{ env.APPROVER_EMAIL }}
          DB_URI: ${{ secrets.DB_URI }}
          IDENTITY_EMAIL: ${{ secrets.IDENTITY_EMAIL }}
          NODE_OPTIONS: ${{ vars.NODE_OPTIONS }}
          PUBLIC_KEY: ${{ vars.PUBLIC_KEY_JWK }}
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY_JWK }}
          SIGNING_SECRET: ${{ secrets.SIGNING_SECRET }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        run: |
          aws lambda update-function-configuration \
              --function-name="${{ needs.get-name.outputs.HANDLER_NAME }}" \
              --environment "Variables={API_URL='${API_URL}',
                                        APPROVER_EMAIL='${APPROVER_EMAIL}',
                                        DB_URI='${DB_URI}',
                                        IDENTITY_EMAIL='${IDENTITY_EMAIL}',
                                        NODE_OPTIONS='${NODE_OPTIONS}',
                                        PUBLIC_KEY='${PUBLIC_KEY}',
                                        PRIVATE_KEY='${PRIVATE_KEY}',
                                        SIGNING_SECRET='${SIGNING_SECRET}',
                                        SMTP_USERNAME='${SMTP_USERNAME}',
                                        SMTP_PASSWORD='${SMTP_PASSWORD}'}" > /dev/null
          aws lambda wait function-updated --function-name "${{ needs.get-name.outputs.HANDLER_NAME }}"


  build-content:
    name: Build static content
    runs-on: ubuntu-latest
    environment: AWS_Development
    needs:
      - get-name
      - deploy-handler
    env:
      NAME: ${{ needs.get-name.outputs.NAME }}

    steps:
      - name: Checkout branch ${{ github.ref_name }}
        uses: actions/checkout@v3

      - name: Install Node.js version ${{ vars.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ vars.NODE_VERSION }}

      - name: Set NODE_ENV for production
        run: echo "NODE_ENV=production" >> $GITHUB_ENV
        if: github.ref_name == 'main'
      - name: Set NODE_ENV for development
        run: echo "NODE_ENV=development" >> $GITHUB_ENV
        if: github.ref_name != 'main'

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build CSS
        working-directory: frontend
        run: npm run build-css

      - name: Build GraphiQL
        working-directory: frontend
        run: npm run build-graphiql

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: ${{ vars.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}

      - name: Render content
        working-directory: dist/frontend/
        # Templating: replace...
        # {% STAGE %} with ${{ github.ref_name }} if ${{ github.ref_name }} != 'main' else ""
        # {% COMMIT_HASH_SHORT %} with the first 7 characters of $GITHUB_SHA if ${{ github.ref_name }} != 'main' else ""
        # {% API_URL %} with $ROOT_API_URL/${{ github.ref_name }}
        run: |
          declare -A TOKENS_REPLACEMENTS
          TOKENS_REPLACEMENTS[{% STAGE %}]=""
          TOKENS_REPLACEMENTS[{% COMMIT_HASH_SHORT %}]=""
          if [[ ${{ github.ref_name }} != 'main' ]]; then
              TOKENS_REPLACEMENTS[{% STAGE %}]="${{ github.ref_name }}"
              TOKENS_REPLACEMENTS[{% COMMIT_HASH_SHORT %}]=${GITHUB_SHA:0:7}
          fi
          TOKENS_REPLACEMENTS[{% API_URL %}]="${{ needs.deploy-handler.outputs.API_URL }}"
          shopt -s globstar
          for view in **/*.html; do
              for token in "${!TOKENS_REPLACEMENTS[@]}"; do
                  sed -i "s~${token}~${TOKENS_REPLACEMENTS[$token]}~g" "${view}"
              done
          done

      - name: Upload content as artifact
        uses: actions/upload-artifact@v3
        with:
          name: frontend_${{ env.NAME }}
          path: dist/frontend/*

  sync-content:
    name: Sync content with S3
    runs-on: ubuntu-latest
    environment: AWS_Development
    needs:
      - get-name
      - build-content

    steps:

      - name: Download content as artifact
        uses: actions/download-artifact@v3
        with:
          name: frontend_${{ needs.get-name.outputs.NAME }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: ${{ vars.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}

      - name: Sync content with S3
        run: |
          aws s3 sync --delete . s3://${{ vars.HOSTING_BUCKET }}/${{ needs.get-name.outputs.NAME }}/
